#!/bin/bash

# get version from argument
version=$1

# check for version
[ -n $version ] && (echo "usage: publish <version>"; exit 1)

# docker login
docker login -e $DOCKER_EMAIL -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

# setup temp dir
tmp=$(mktemp -d -t release.XXXXX)

# publish rack
clone_mtime https://github.com/convox/rack $tmp/rack
cd $tmp/rack && make publish VERSION=$V

# publish registry
clone_mtime https://github.com/convox/registry $tmp/registry
cd $tmp/registry && make publish VERSION=$V

version -publish update $tag

# notify
echo "rack release published: $version"
curl -s -X POST -d "payload={\"text\":\"rack release published: $version\"}" $SLACK_WEBHOOK_URL
